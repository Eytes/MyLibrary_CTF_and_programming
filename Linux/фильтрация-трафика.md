В Linux-системах есть встроенный Firewall (или хостовый firewall). За него отвечают утилиты `iptables` и `firewalld`.

## Iptables
### Архитектура iptables:

    Rule (правило) — в правиле может содержаться условие, счётчик и действие, которое будет применено к пакету.
    Chain (цепочка) — может быть пользовательской или системной. В системные цепочки входят: prerouting, input, forward, output, postrouting.
    Table (таблица) — объединяет в «пак» цепочки. По умолчанию есть единственная таблица под названием filter.

Общий принцип работы firewall: разрешено всё, что явно не запрещено. То есть если отсутствует запрещающее правило на тот или иной пакет, то firewall его пропустит. Правила применяются последовательно от верхнего к нижнему (либо до первого правила, которому будет отнесён пакет).\
Например:

    Первое правило разрешает все пакеты.
    Второе правило разрешает все UDP-пакеты.
    Третье правило запрещает все UDP-пакеты на порт 22.

Если будет получен UDP-пакет на порт 22, он пройдёт, так как попадает под первое правило: разрешить все пакеты. Если третье правило поставить первым: запретить все UDP-пакеты на 22 порт, то пакет будет отброшен.
Чтобы перейти к написанию своего первого правила, необходимо разобраться с цепочками и их функционалом.

![image](https://github.com/Eytes/MyLibrary_CTF_and_programming/assets/67365128/bb8f9a81-94a2-4dfe-9162-04199b6ae080)

    Prerouting — в эту цепочку попадают все входящие пакеты до того, как будет принято решение о том, кому он предназначается (input или forward).
    Input — в эту цепочку попадают все пакеты, предназначенные для конечного узла.
    Forward — в эту цепочку попадают пакеты, которые проходят через этот узел, но предназначены другому (в случае, если Linux-машина выступает как шлюз или прокси, например).
    Output — в этой цепочке окажутся все пакеты, которые будут отправлены от самого хоста (исходящий трафик).
    Postrouting — применяется ко всем пакетам, которые будут отправлены через сетевой интерфейс (в том числе прошедшие фильтрацию prerouting, forward или output).

Системные цепочки, в которых по умолчанию всегда будет хотя бы одно правило: это «разрешать весь трафик», input и output. Это сделано с целью изначальной работоспособности сети.

Каждое правило имеет:

    критерий (для фильтрации);
    действие (что делаем, когда пакет попадает под критерий);
    счётчик (сколько пакетов попало под действие правила, объём в байтах).

### Критерий правила

Основные критерии:

    -p протокол — может быть как числом (подглядеть можно в /etc/protocols), так и буквами ICMP, TCP. iptables -A INPUT -p tcp — разрешаем входящие соединения по TCP.
    -s — ip-адрес источника. iptables -A INPUT -s 10.11.11.111 -j REJECT — отбрасываем все входящие пакеты с адреса 10.11.11.111.
    -d — ip-адрес назначения. iptables -A OUTPUT -p UDP -d 8.8.8.8 -j ACCEPT — разрешаем соединения на 8.8.8.8 по протоколу UDP.
    -i — интерфейс, с которого был получен пакет — iptables -A INPUT -i eth0.
    --sport — исходящий порт, используется совместно с -p (с указанием TCP или UDP). iptables -A INPUT -p tcp --sport 22 -j DROP — блокируем соединения с 22 нашего порта TCP.
    --dport — порт назначения (получателя), используется совместно с -p (с указанием TCP или UDP). iptables -A OUTPUT -p tcp --dport 22 -j ACCEPT — разрешаем исходящие подключения на 22 порт TCP.

### Действие правила

Основные действия, которые могут пригодиться:

    ACCEPT — разрешить движение пакета;
    DROP — отбросить пакет;
    REJECT — отбросить пакет с сообщением об ошибке хосту-отправителю.

Этих знаний будет достаточно для того, чтобы написать простые правила по обработке пакетов с помощью iptables.

В Linux-системах есть встроенный Firewall (или хостовый firewall). За него отвечают утилиты `iptables` и `firewalld`.

## Iptables
### Архитектура iptables:

>`Rule` (правило) — в правиле может содержаться условие, счётчик и действие, которое будет применено к пакету.\
>`Chain` (цепочка) — может быть пользовательской или системной. В системные цепочки входят: *prerouting*, *input*, *forward*, *output*, *postrouting*.\
>`Table` (таблица) — объединяет в «пак» цепочки. По умолчанию есть единственная таблица под названием **filter**.

### Цепочки
Существует 5 видов цепочек:

> `PREROUTING` — предназначена для первичной обработки входящих пакетов, адресованных как непосредственно серверу, так и другим узлам сети. Сюда попадает абсолютно весь входящий трафик для дальнейшего анализа.\
>`INPUT` — для входящих пакетов, отправленных непосредственно этому серверу.\
>`FORWARD` — для проходящих пакетов, не адресованных этому компьютеру, предназначены для передачи следующему узлу, в случае, если сервер выполняет роль маршрутизатора.\
>`OUTPUT` — для пакетов, отправленных с этого сервера.\
>`POSTROUTING` — здесь оказываются пакеты, предназначенные для передачи на другие узлы сети.

Также есть возможность создавать и удалять собственные цепочки, в большинстве случаев, в этом нет необходимости. Названия цепочек пишут заглавными буквами.

### Таблицы

В netfilter существуют 5 типов таблиц, каждая из них имеет свое назначение.
>`raw` cодержит цепочки **PREROUTING** и **OUTPUT**, здесь производятся манипуляции с пакетами до задействования механизма определения состояний.
>
>`mangle` предназначена для модификации заголовков сетевых пакетов, таких параметров как _ToS_ (Type of Service), _TTL_ (Time To Live), _MARK_. Содержит все существующие пять цепочек.
>
>`nat` используется для трансляции сетевых адресов, т.е. подмены адреса получателя/отправителя, применяется, если сервер используется в качестве маршрутизатора. Содержит цепочки **PREROUTING**, **OUTPUT**, **POSTROUTING**.
>
>`filter` основная таблица, служит для фильтрации пакетов, именно здесь происходит принятие решений о разрешении или запрете дальнейшего движения пакета в системе. Используется по умолчанию, если явно не указано имя другой таблицы. Содержит цепочки **INPUT**, **FORWARD** и **OUTPUT**.
>
>`security` используется для взаимодействия с внешними системами безопасности, в частности с _SELinux_ и _AppArmor_. Содержит цепочки **INPUT**, **OUTPUT** и **FORWARD.

Имена таблиц принято писать строчными буквами.

### Общий принцип работы firewall: 
>- разрешено всё, что явно не запрещено. То есть если отсутствует запрещающее правило на тот или иной пакет, то firewall его пропустит.
>- Правила применяются последовательно от верхнего к нижнему (либо до первого правила, которому будет отнесён пакет).

Например:
- Первое правило разрешает все пакеты.
- Второе правило разрешает все UDP-пакеты.
- Третье правило запрещает все UDP-пакеты на порт 22.

Если будет получен UDP-пакет на порт 22, он пройдёт, так как попадает под первое правило: разрешить все пакеты. Если третье правило поставить первым: запретить все UDP-пакеты на 22 порт, то пакет будет отброшен.
Чтобы перейти к написанию своего первого правила, необходимо разобраться с цепочками и их функционалом.

![image](https://github.com/Eytes/MyLibrary_CTF_and_programming/assets/67365128/bb8f9a81-94a2-4dfe-9162-04199b6ae080)

>`POSTROUTING` — в эту цепочку попадают все входящие пакеты до того, как будет принято решение о том, кому он предназначается (*input* или *forward*).\
>`INPUT` — в эту цепочку попадают все пакеты, предназначенные для конечного узла.\
>`FORWARD` — в эту цепочку попадают пакеты, которые проходят через этот узел, но предназначены другому (в случае, если Linux-машина выступает как шлюз или прокси, например).\
>`OUTPUT` — в этой цепочке окажутся все пакеты, которые будут отправлены от самого хоста (исходящий трафик).\
>`POSTROUTING` — применяется ко всем пакетам, которые будут отправлены через сетевой интерфейс (в том числе прошедшие фильтрацию *prerouting*, *forward* или *output*).

Системные цепочки, в которых по умолчанию всегда будет хотя бы одно правило: это «разрешать весь трафик», input и output. Это сделано с целью изначальной работоспособности сети.

Каждое правило имеет:

1. действие (что делаем, когда пакет попадает под критерий);
2. критерий (для фильтрации);
3. счётчик (сколько пакетов попало под действие правила, объём в байтах).

### Действие правила

Правилами задается поведение для `iptables`, каким образом поступить с тем или иным пакетом при попадании под заданные критерии. Решения, которые принимает брандмауэр, называют действиями, самые распространенные из них:

>`ACCEPT` — разрешить движение пакета;\
>`DROP` — отбросить пакет;\
>`REJECT` — отбросить пакет с сообщением об ошибке хосту-отправителю.\
>`LOG` — зафиксировать информацию о пакете в файле системного журнала;\
>`MARK` — позволяет помечать определенные пакеты, например для маршрутизации, данная метка перестает существовать, как только пакет покинет брандмауэр;\
>`CONNMARK` — то же самое, что и MARK, только для соединений;\
>`QUEUE` — отправляет пакет в очередь приложению для дальнейшего взаимодействия;\
>`RETURN` — прекращение движения пакета по текущей цепочке и возврат в предыдущую цепочку. Если текущая цепочка единственная — к пакету будет применено действие по умолчанию;\
>`REDIRECT` — перенаправляет пакет на указанный порт, в пределах этого же узла, применяется для реализации «прозрачного» прокси;\
>`DNAT` — подменяет адрес получателя в заголовке IP-пакета, основное применение — предоставление доступа к сервисам снаружи, находящимся внутри сети;\
>`SNAT` — служит для преобразования сетевых адресов, применимо, когда за сервером находятся машины, которым необходимо предоставить доступ в Интернет, при этом от провайдера имеется статический IP-адрес;\
>`MASQUERADE` — то же, что и SNAT, но главное отличие в том, что может использоваться, когда провайдер предоставляет динамический адрес, создаёт дополнительную нагрузку на систему по сравнению с SNAT;\
>`TOS` — позволяет управлять битами в одноименном поле заголовка IP-пакета;\
>`ULOG` — более продвинутый вариант записи информации, может писать как в обычный текстовый файл, так и в базу данных;\
>`TTL` — используется для изменения значения поля одноименного заголовка IP-пакета, устанавливает время жизни пакета.

### Критерий правила

Основные критерии:

>`-p` протокол — может быть как числом (подглядеть можно в /etc/protocols), так и буквами ICMP, TCP. `iptables -A INPUT -p tcp` — разрешаем входящие соединения по TCP.
>
>`-s` — ip-адрес источника. `iptables -A INPUT -s 10.11.11.111 -j REJECT` — отбрасываем все входящие пакеты с адреса 10.11.11.111.
>
>`-d` — ip-адрес назначения. `iptables -A OUTPUT -p UDP -d 8.8.8.8 -j ACCEPT` — разрешаем соединения на 8.8.8.8 по протоколу UDP.
>
>`-i` — интерфейс, с которого был получен пакет — `iptables -A INPUT -i eth0`.
>
>`--sport` — исходящий порт, используется совместно с -p (с указанием TCP или UDP). `iptables -A INPUT -p tcp --sport 22 -j DROP` — блокируем соединения с 22 нашего порта TCP.\
>
>`--dport` — порт назначения (получателя), используется совместно с -p (с указанием TCP или UDP). `iptables -A OUTPUT -p tcp --dport 22 -j ACCEPT` — разрешаем исходящие подключения на 22 порт TCP.
